<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم التبرعات - معاً لتحقيق الأهداف</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #020617;
      border-inline-end: 1px solid #111827;
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .logo {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .side-sub {
      font-size: 12px;
      color: #6b7280;
    }
    .nav-section-title {
      font-size: 12px;
      color: #6b7280;
      margin: 14px 0 4px;
    }
    .nav-btn {
      width: 100%;
      text-align: right;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      display: block;
    }
    .nav-btn.active,
    .nav-btn:hover {
      background: #111827;
    }
    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      color: #6b7280;
    }

    .main {
      flex: 1;
      padding: 20px 18px 26px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    .top-title {
      font-size: 20px;
      font-weight: 600;
    }
    .top-sub {
      font-size: 12px;
      color: #9ca3af;
    }
    .logout-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #f9fafb;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .logout-btn:hover { background: #1f2937; }

    .cards {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-bottom: 18px;
    }
    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 14px 12px;
    }
    .card-title {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 20px;
      font-weight: 600;
    }
    .card-foot {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .section {
      margin-top: 18px;
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 14px 12px 16px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
    }
    .section-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
    }
    input, select {
      width: 100%;
      padding: 8px 9px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      margin-bottom: 10px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
    }
    .btn-ghost {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    .btn:disabled { opacity: 0.6; cursor: wait; }

    .status {
      font-size: 12px;
      min-height: 18px;
      margin-top: 4px;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 12px;
    }

    /* جدول التبرعات */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #111827;
      text-align: right;
    }
    th {
      color: #9ca3af;
      font-weight: 500;
      background: #020617;
      position: sticky;
      top: 0;
    }
    tr:hover td {
      background: #020617;
    }
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #111827;
      margin-top: 4px;
    }
    .row-clickable {
      cursor: pointer;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #022c22;
      color: #6ee7b7;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      width: 100%;
      max-width: 420px;
      padding: 16px 14px 16px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }
    .close-btn {
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #6b7280;
    }
    .modal-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      body { padding-top: 10px; }
      .main { padding-inline: 12px; }
    }
  </style>
</head>
<body>
  <!-- الشريط الجانبي -->
  <aside class="sidebar">
    <div>
      <div class="logo">معاً لتحقيق الأهداف</div>
      <div class="side-sub">لوحة إدارة التبرعات</div>
    </div>

    <div>
      <div class="nav-section-title">الأقسام</div>
      <button class="nav-btn active">الملخص والتبرعات</button>
      <!-- يمكن إضافة أزرار أخرى لاحقاً -->
    </div>

    <div class="sidebar-footer">
      هذا النظام مخصّص لفريق الجمعية فقط.
    </div>
  </aside>

  <!-- المحتوى الرئيسي -->
  <main class="main">
    <div class="top-bar">
      <div>
        <div class="top-title">لوحة التحكم</div>
        <div class="top-sub">إدارة التبرعات والأهداف في الوقت الفعلي</div>
      </div>
      <button id="logoutBtn" class="logout-btn">تسجيل الخروج</button>
    </div>

    <!-- البطاقات -->
    <section class="cards">
      <div class="card">
        <div class="card-title">إجمالي التبرعات</div>
        <div class="card-value" id="cardTotal">0</div>
        <div class="card-foot">يتم التحديث تلقائياً</div>
      </div>
      <div class="card">
        <div class="card-title">الهدف الحالي</div>
        <div class="card-value" id="cardGoal">غير محدد</div>
        <div class="card-foot" id="cardGoalFoot"></div>
      </div>
      <div class="card">
        <div class="card-title">عدد آخر التبرعات المعروضة</div>
        <div class="card-value" id="cardCount">0</div>
        <div class="card-foot">في الجدول أدناه</div>
      </div>
    </section>

    <!-- إضافة تبرع + إعداد الهدف + reset -->
    <section class="section">
      <div class="section-header">
        <div>
          <div class="section-title">إدارة التبرعات والهدف</div>
          <div class="section-sub">
            أضف تبرعاً جديداً، غيّر الهدف، أو أعد ضبط الحملة الحالية.
          </div>
        </div>
      </div>

      <div class="form-grid">
        <!-- نموذج التبرع -->
        <div>
          <label for="name">اسم المتبرع (اختياري)</label>
          <input id="name" type="text" placeholder="مثال: فاعل خير" />

          <label for="amount">المبلغ (جنيه سوداني)</label>
          <input id="amount" type="number" min="1" step="1" placeholder="مثال: 5000" />

          <button id="addDonationBtn" class="btn btn-primary" style="width:100%; margin-top:4px;">إضافة التبرع</button>
          <div id="donationStatus" class="status"></div>
        </div>

        <!-- إعداد الهدف -->
        <div>
          <label for="goalInput">الهدف الجديد (ج.س)</label>
          <input id="goalInput" type="number" min="1" step="1" placeholder="مثال: 2000000" />

          <button id="updateGoalBtn" class="btn btn-ghost" style="width:100%; margin-top:4px;">
            تحديث / إنشاء الهدف
          </button>
          <div id="goalStatus" class="status"></div>

          <button id="resetBtn" class="btn btn-danger" style="width:100%; margin-top:10px;">
            إعادة ضبط التبرعات الحالية
          </button>
          <div id="resetStatus" class="status"></div>
        </div>
      </div>
    </section>

    <!-- جدول التبرعات -->
    <section class="section" style="margin-top:16px;">
      <div class="section-header">
        <div>
          <div class="section-title">جدول التبرعات</div>
          <div class="section-sub">انقر على صف لتعديل التبرع أو حذفه.</div>
        </div>
        <div style="font-size:12px;">
          <span class="tag">يتم تحميل آخر 100 تبرع</span>
        </div>
      </div>

      <!-- فلاتر بسيطة -->
      <div class="form-grid" style="margin-bottom:4px;">
        <div>
          <label for="filterName">بحث بالاسم</label>
          <input id="filterName" type="text" placeholder="اكتب جزءاً من اسم المتبرع" />
        </div>
        <div>
          <label for="filterMin">الحد الأدنى للمبلغ</label>
          <input id="filterMin" type="number" min="0" placeholder="مثال: 1000" />
        </div>
        <div>
          <label for="filterMax">الحد الأقصى للمبلغ</label>
          <input id="filterMax" type="number" min="0" placeholder="مثال: 100000" />
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>الاسم</th>
              <th>المبلغ</th>
              <th>التاريخ</th>
              <th>المعرف</th>
            </tr>
          </thead>
          <tbody id="donationsTableBody">
            <tr><td colspan="4">لا توجد بيانات بعد.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal تعديل التبرع -->
  <div class="modal-backdrop" id="editModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">تعديل التبرع</div>
        <div class="close-btn" id="closeModalBtn">&times;</div>
      </div>

      <div>
        <label for="editName">اسم المتبرع</label>
        <input id="editName" type="text" />

        <label for="editAmount">المبلغ (ج.س)</label>
        <input id="editAmount" type="number" min="1" step="1" />

        <div style="font-size:11px; color:#9ca3af; margin-bottom:4px;">
          معرف التبرع:
          <span id="editId" style="direction:ltr; display:inline-block;"></span>
        </div>
        <div id="editStatus" class="status"></div>
      </div>

      <div class="modal-footer">
        <button id="deleteDonationBtn" class="btn btn-danger">حذف التبرع</button>
        <button id="saveDonationBtn" class="btn btn-primary">حفظ التعديلات</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      addDoc,
      serverTimestamp,
      increment,
      query,
      orderBy,
      limit,
      onSnapshot,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2FLWsDegWYdHLjm89pNyoNvnRkTvxdMA",
      authDomain: "together-b.firebaseapp.com",
      projectId: "together-b",
      storageBucket: "together-b.appspot.com",
      messagingSenderId: "106482180658",
      appId: "1:106482180658:web:3685f9ed68a67ca1e4922b",
      measurementId: "G-VKM59LEWK7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // عناصر الواجهة
    const logoutBtn = document.getElementById("logoutBtn");

    const nameInput = document.getElementById("name");
    const amountInput = document.getElementById("amount");
    const addDonationBtn = document.getElementById("addDonationBtn");
    const donationStatus = document.getElementById("donationStatus");

    const goalInput = document.getElementById("goalInput");
    const updateGoalBtn = document.getElementById("updateGoalBtn");
    const goalStatus = document.getElementById("goalStatus");
    const resetBtn = document.getElementById("resetBtn");
    const resetStatus = document.getElementById("resetStatus");

    const cardTotal = document.getElementById("cardTotal");
    const cardGoal = document.getElementById("cardGoal");
    const cardGoalFoot = document.getElementById("cardGoalFoot");
    const cardCount = document.getElementById("cardCount");

    const filterName = document.getElementById("filterName");
    const filterMin = document.getElementById("filterMin");
    const filterMax = document.getElementById("filterMax");
    const tableBody = document.getElementById("donationsTableBody");

    // modal
    const editModalBackdrop = document.getElementById("editModalBackdrop");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const editName = document.getElementById("editName");
    const editAmount = document.getElementById("editAmount");
    const editIdEl = document.getElementById("editId");
    const editStatus = document.getElementById("editStatus");
    const deleteDonationBtn = document.getElementById("deleteDonationBtn");
    const saveDonationBtn = document.getElementById("saveDonationBtn");

    let donationsCache = []; // نخزن آخر 100 تبرع هنا
    let currentEdit = null;  // {id, ref, data}

    const formatAmount = (v) => {
      try { return Number(v).toLocaleString("ar-EG"); }
      catch { return v; }
    };

    // تأمين الصفحة: يجب أن يكون المستخدم مسجّل دخول
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "admin-login.html";
      } else {
        console.log("Admin UID:", user.uid);
        initDashboard();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "admin-login.html";
    });

    // تهيئة اللوحة
    function initDashboard() {
      setupTotalListener();
      setupGoalListener();
      setupDonationsListener();
      setupForms();
    }

    function setupTotalListener() {
      const totalRef = doc(db, "donations", "total");
      // نستخدم getDoc مرة واحدة ثم listener في index.html، هنا يكفي getDoc
      getDoc(totalRef).then((snap) => {
        const total = snap.exists() ? snap.data().amount || 0 : 0;
        cardTotal.textContent = formatAmount(total) + " ج.س";
      });
    }

    function setupGoalListener() {
      const settingsRef = doc(db, "donations", "settings");
      getDoc(settingsRef).then((snap) => {
        if (snap.exists()) {
          const data = snap.data();
          cardGoal.textContent = formatAmount(data.goal) + " ج.س";
          cardGoalFoot.textContent = "هدف الحملة الحالي.";
          goalInput.value = data.goal;
        } else {
          cardGoal.textContent = "غير محدد";
          cardGoalFoot.textContent = "قم بإنشاء هدف جديد من الأسفل.";
        }
      });
    }

    function setupDonationsListener() {
      const q = query(
        collection(db, "donations_list"),
        orderBy("time", "desc"),
        limit(100)
      );

      onSnapshot(q, (snapshot) => {
        donationsCache = [];
        snapshot.forEach((docSnap) => {
          donationsCache.push({
            id: docSnap.id,
            ref: docSnap.ref,
            ...docSnap.data()
          });
        });
        renderDonationsTable();
        cardCount.textContent = donationsCache.length;
      });
    }

    function applyFilters(row) {
      const nameFilter = filterName.value.trim().toLowerCase();
      const min = Number(filterMin.value || "0");
      const max = Number(filterMax.value || "0");

      if (nameFilter && !String(row.name || "").toLowerCase().includes(nameFilter)) {
        return false;
      }
      if (min && row.amount < min) return false;
      if (max && row.amount > max) return false;
      return true;
    }

    function renderDonationsTable() {
      tableBody.innerHTML = "";
      const filtered = donationsCache.filter(applyFilters);

      if (!filtered.length) {
        tableBody.innerHTML = '<tr><td colspan="4">لا توجد نتائج مطابقة للفلاتر.</td></tr>';
        return;
      }

      filtered.forEach((d) => {
        const tr = document.createElement("tr");
        tr.classList.add("row-clickable");
        tr.dataset.id = d.id;

        const dateText = d.time && d.time.toDate
          ? d.time.toDate().toLocaleString("ar-EG")
          : "";

        tr.innerHTML = `
          <td>${d.name || "متبرّع"}</td>
          <td>${formatAmount(d.amount || 0)} ج.س</td>
          <td>${dateText}</td>
          <td style="direction:ltr;">${d.id}</td>
        `;
        tr.addEventListener("click", () => openEditModal(d.id));
        tableBody.appendChild(tr);
      });
    }

    // إعادة رسم الجدول عند تغيّر الفلاتر
    [filterName, filterMin, filterMax].forEach((el) => {
      el.addEventListener("input", renderDonationsTable);
    });

    function setupForms() {
      // إضافة تبرع جديد
      addDonationBtn.addEventListener("click", async () => {
        donationStatus.textContent = "";
        donationStatus.className = "status";

        const rawAmount = amountInput.value.trim();
        const amount = Number(rawAmount);
        const name = nameInput.value.trim() || "متبرّع";

        if (!amount || amount <= 0) {
          donationStatus.textContent = "الرجاء إدخال مبلغ صالح أكبر من صفر.";
          donationStatus.classList.add("err");
          return;
        }

        addDonationBtn.disabled = true;

        try {
          const totalRef = doc(db, "donations", "total");
          const totalSnap = await getDoc(totalRef);
          if (!totalSnap.exists()) {
            await setDoc(totalRef, { amount: 0 });
          }

          await addDoc(collection(db, "donations_list"), {
            name,
            amount,
            time: serverTimestamp()
          });

          await updateDoc(totalRef, {
            amount: increment(amount)
          });

          donationStatus.textContent = "تم حفظ التبرع بنجاح ✅";
          donationStatus.classList.add("ok");
          amountInput.value = "";
          nameInput.value = "";
          setupTotalListener(); // تحديث البطاقة
        } catch (err) {
          console.error(err);
          donationStatus.textContent = "حدث خطأ أثناء الحفظ.";
          donationStatus.classList.add("err");
        } finally {
          addDonationBtn.disabled = false;
        }
      });

      // تحديث / إنشاء الهدف
      updateGoalBtn.addEventListener("click", async () => {
        goalStatus.textContent = "";
        goalStatus.className = "status";

        const rawGoal = goalInput.value.trim();
        const goalValue = Number(rawGoal);

        if (!goalValue || goalValue <= 0) {
          goalStatus.textContent = "الهدف غير صالح.";
          goalStatus.classList.add("err");
          return;
        }

        updateGoalBtn.disabled = true;

        try {
          const settingsRef = doc(db, "donations", "settings");
          await setDoc(settingsRef, {
            goal: goalValue,
            updatedAt: serverTimestamp()
          });

          goalStatus.textContent = "تم تحديث الهدف بنجاح ✅";
          goalStatus.classList.add("ok");
          setupGoalListener();
        } catch (err) {
          console.error(err);
          goalStatus.textContent = "فشل في تحديث الهدف.";
          goalStatus.classList.add("err");
        } finally {
          updateGoalBtn.disabled = false;
        }
      });

      // إعادة ضبط التبرعات
      resetBtn.addEventListener("click", async () => {
        resetStatus.textContent = "";
        resetStatus.className = "status";

        if (!confirm("هل أنت متأكد من إعادة ضبط إجمالي التبرعات وحذف السجل الحالي؟")) {
          return;
        }

        resetBtn.disabled = true;

        try {
          // إعادة الإجمالي للصفر
          await setDoc(doc(db, "donations", "total"), {
            amount: 0
          });

          // حذف جميع المستندات في donations_list
          const snap = await getDocs(collection(db, "donations_list"));
          const batchPromises = [];
          snap.forEach((d) => {
            batchPromises.push(deleteDoc(d.ref));
          });
          await Promise.all(batchPromises);

          resetStatus.textContent = "تمت إعادة الضبط بنجاح ✅";
          resetStatus.classList.add("ok");
          setupTotalListener();
        } catch (err) {
          console.error(err);
          resetStatus.textContent = "فشل في إعادة الضبط.";
          resetStatus.classList.add("err");
        } finally {
          resetBtn.disabled = false;
        }
      });
    }

    // --------- Modal تعديل التبرع ----------
    function openEditModal(id) {
      const row = donationsCache.find((d) => d.id === id);
      if (!row) return;

      currentEdit = row;
      editName.value = row.name || "";
      editAmount.value = row.amount || 0;
      editIdEl.textContent = row.id;
      editStatus.textContent = "";
      editStatus.className = "status";

      editModalBackdrop.style.display = "flex";
    }

    function closeEditModal() {
      editModalBackdrop.style.display = "none";
      currentEdit = null;
    }

    closeModalBtn.addEventListener("click", closeEditModal);
    editModalBackdrop.addEventListener("click", (e) => {
      if (e.target === editModalBackdrop) {
        closeEditModal();
      }
    });

    // حفظ التعديلات
    saveDonationBtn.addEventListener("click", async () => {
      if (!currentEdit) return;
      editStatus.textContent = "";
      editStatus.className = "status";

      const newName = editName.value.trim() || "متبرّع";
      const newAmount = Number(editAmount.value);
      if (!newAmount || newAmount <= 0) {
        editStatus.textContent = "المبلغ غير صالح.";
        editStatus.classList.add("err");
        return;
      }

      saveDonationBtn.disabled = true;

      try {
        const diff = newAmount - (currentEdit.amount || 0);

        await updateDoc(currentEdit.ref, {
          name: newName,
          amount: newAmount
        });

        if (diff !== 0) {
          const totalRef = doc(db, "donations", "total");
          await updateDoc(totalRef, { amount: increment(diff) });
          setupTotalListener();
        }

        editStatus.textContent = "تم حفظ التعديلات ✅";
        editStatus.classList.add("ok");
      } catch (err) {
        console.error(err);
        editStatus.textContent = "فشل في حفظ التعديلات.";
        editStatus.classList.add("err");
      } finally {
        saveDonationBtn.disabled = false;
      }
    });

    // حذف التبرع
    deleteDonationBtn.addEventListener("click", async () => {
      if (!currentEdit) return;
      if (!confirm("هل أنت متأكد من حذف هذا التبرع؟")) return;

      deleteDonationBtn.disabled = true;

      try {
        const amount = currentEdit.amount || 0;
        await deleteDoc(currentEdit.ref);

        const totalRef = doc(db, "donations", "total");
        await updateDoc(totalRef, { amount: increment(-amount) });
        setupTotalListener();

        closeEditModal();
      } catch (err) {
        console.error(err);
        editStatus.textContent = "فشل في حذف التبرع.";
        editStatus.classList.add("err");
      } finally {
        deleteDonationBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
